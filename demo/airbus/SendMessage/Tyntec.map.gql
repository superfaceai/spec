profile = "http://superface.ai/profile/conversation/SendMessage"
provider = "http://superface.ai/directory/Tyntec#SMS"

# Tyntec API documentation available at:
#   https://api.tyntec.com/reference/#conversations-send-messages-send-a-message

map SendMessage {
  http POST "https://api.tyntec.com/chat-api/v2/messages" {
    request "application/json" {
      headers {
        "ApiKey" = input.auth.apikey.key
      }

      body {
        to = input.to
        channels = ['sms']
        sms.from = input.from
        sms.contentType = 'text'
        sms.text = input.text
      }
    }

    response 200 "application/json" {
      map result {
        messageId = body.messageId
      }
    }
  }
}

map RetrieveMessageStatus {
  messageId = input.messageId

  http GET `https://api.tyntec.com/chat-api/v2/messages/{messageId}/history` {
    body headers {
      "ApiKey" = input.auth.apikey.key
    }

    response 200 "application/json" {
      map result {
        deliveryStatus = body.history[0].state
      }
    }
  } 
}
